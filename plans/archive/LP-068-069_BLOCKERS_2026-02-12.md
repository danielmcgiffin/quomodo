# LP-068 / LP-069 Blockers (2026-02-12, resolved 2026-02-13)

This document captures what failed while executing `LP-068` and `LP-069`, the hypotheses investigated, and how the blockers were resolved.

## Resolution Summary (2026-02-13)

- `LP-068` is now passing end-to-end on production:
- run: `SMOKE_BASE_URL=https://systemscraft.co npm run -s onboarding:deployed`
- timestamp: `2026-02-13T11:11:47.052Z`
- status: `PASS` on signup, verify/sign-in, profile creation, first entities, search, and first flag.

- Root causes resolved:
- Supabase Auth email confirmation failure was SMTP auth (`535 Authentication credentials invalid`); repasting SMTP password in Supabase fixed confirmation sends.
- Onboarding script was posting to `?/action` endpoints as plain form requests; now posts with Svelte action headers, matching browser-enhanced flow.
- Welcome email template rendering was not Cloudflare-safe; `src/lib/mailer.ts` now uses static template rendering without runtime Handlebars codegen.

## Scope

- Goal: close `LP-068` (first-customer onboarding validation) and `LP-069` (multi-user provisioning validation).
- Environment used: `SMOKE_BASE_URL=https://quomodo.danielmcgiffin.workers.dev` (and one cross-check against `https://systemscraft.co`).
- Date of evidence: 2026-02-12 (UTC).

## What Worked

- `LP-069` provisioning path executed successfully via `npm run -s provision:workspace`.
- Run evidence:
- `run_date_utc=2026-02-12T21:57:35.435Z`
- `org_id=851f91e4-7bc0-426c-bf70-b3c0b4687ce4`
- `PASS` admin membership assignment + verification
- `PASS` editor membership assignment + verification
- `PASS` member membership assignment + verification

- `LP-069` smoke validation now passes on canonical domain.
- Run evidence:
- `run_date_utc=2026-02-13T10:46:31.889Z`
- `base_url=https://systemscraft.co`
- `PASS` login, RBAC, CRUD, portals, search, flags, billing

## What Failed

- Deployed smoke (`npm run -s smoke:deployed`) failed at first app access check.
- Failure detail:
- owner authenticated successfully, then `/app/processes` returned HTTP `500` instead of `200`
- reproduced on both `https://quomodo.danielmcgiffin.workers.dev` and `https://systemscraft.co`
- Error page showed reference id:
- `ref: 054f92da-2cbd-4bf4-afdd-f9503b434450`

- Onboarding validation (`npm run -s onboarding:deployed`) failed before end-to-end completion.
- Run 1 failure:
- signup email format rejected by Supabase (`Email address "... is invalid"`)
- Run 2 failure:
- Supabase email rate limit (`email rate limit exceeded`)
- Run 3 (with fallback user creation):
- signup step `PASS` (admin fallback due rate limit)
- verify/sign-in step `PASS`
- profile creation step `FAIL` (`/account/api?/updateProfile` returned `500`)
- run timestamp: `2026-02-12T22:09:03.537Z`

## Re-Run After Route Fix (2026-02-13)

- Context:
- `wrangler.jsonc` route patterns were corrected from invalid custom-domain wildcards to valid host patterns and a new build/deploy completed.

- Results:
- `SMOKE_BASE_URL=https://quomodo.danielmcgiffin.workers.dev npm run -s smoke:deployed`
  - `FAIL`: owner `/app/processes` returned `404` (workers.dev path now not serving the app route target used by smoke script).
- `SMOKE_BASE_URL=https://systemscraft.co npm run -s smoke:deployed`
  - `FAIL` (initially): owner `/app/processes` returned `500` on canonical domain.
- `SMOKE_BASE_URL=https://systemscraft.co npm run -s onboarding:deployed`
  - `FAIL`: signup step fails with `Error sending confirmation email`.
- `npm run -s provision:workspace`
  - `PASS`: admin/editor/member provisioning and membership verification still succeed.

## Runtime 500 Root Cause + Fix (2026-02-13)

- Root cause captured from live tail (`wrangler tail`):

  - route: `/app/processes`
  - context: `hooks.handleError`
  - stack originated in rich-text HTML rendering (`generateHTML`) with server/runtime incompatibility in Workers.

- Fix implemented:

  - replaced TipTap HTML runtime rendering path in `src/lib/server/rich-text.ts` with a Cloudflare-safe local renderer (no VM/JSDOM dependency at request time).
  - rebuilt and redeployed worker.
  - deployment version: `072d5ea0-10e7-4967-ab88-592978e09346`

- Validation after fix:
  - `SMOKE_BASE_URL=https://systemscraft.co npm run -s smoke:deployed` now fully `PASS`.

## Quick Data Sanity Checks Already Done

- Owner sign-in with anon key succeeded.
- Owner membership lookup succeeded with owner role in org `851f91e4-7bc0-426c-bf70-b3c0b4687ce4`.
- Basic owner-scoped queries succeeded for `processes`, `roles`, `systems`, and `flags`.
- These checks suggest the data and RLS baseline are not completely broken.

## Ranked Hypotheses (Historical; validated 2026-02-13)

1. Supabase Auth confirmation-email path is still misconfigured in production (SMTP sender/domain/template or provider credentials), causing `Error sending confirmation email`.
2. Resend sender identity/domain alignment in Supabase Auth may not match a verified sender identity in Resend for the exact From address.
3. Less likely: project-level auth/email limits or provider-side policy are rejecting confirmation sends for this project.

## Checks For Danny (Completed)

- Cloudflare logs:
- No longer required for `/app/processes` launch blocker (root cause identified + fixed + smoke PASS).

- Supabase schema checks (production project):
- Confirm `profiles` has expected columns used by current code:
- `id`, `updated_at`, `full_name`, `company_name`, `website`, `unsubscribed`
- Confirm trigger/function path for new users exists and is active:
- `public.handle_new_user`
- `on_auth_user_created` trigger on `auth.users`

- Secret/config alignment checks:
- Confirm all deployed env values point at the same Supabase project:
- `PUBLIC_SUPABASE_URL`
- `PUBLIC_SUPABASE_ANON_KEY`
- `PRIVATE_SUPABASE_SERVICE_ROLE`
- Confirm production and preview are in sync for required app secrets.

- Auth/rate-limit checks:
- Re-pasted Supabase SMTP password and re-tested signup; confirmation email send path is now healthy.

## Checks For Codex After Confirmation

- Re-run:
- `npm run -s smoke:deployed`
- `npm run -s onboarding:deployed`
- Capture new timestamped PASS/FAIL results.
- Completed:
- `onboarding:deployed` now passes on production (`2026-02-13T11:11:47.052Z`).

## Gemini Review: What Is Accurate vs Overstated

- Accurate:
- `src/routes/app/processes/[slug]/+page.server.ts` is a large mixed-responsibility route and is less clean than roles/systems routes.
- `resequenceProcessActions` is non-transactional and should eventually move to DB-side function/RPC for stronger safety.

- Partially accurate:
- Flag creation duplication exists, but process detail supports both `process` and `action` targets, which current shared helper does not model directly.
- So some inline logic is architectural debt, not necessarily a bug.

- Overstated:
- Current failures are runtime/deployment blockers (`500`s in critical flows), not proof that the whole architecture is broken.
- We have successful provisioning and successful direct DB auth/path checks in the same environment.

## Recommended Next Move

- Resolve the concrete runtime `500` root causes first (launch blockers).
- After launch blockers are closed, do the structural cleanup of `processes/[slug]` into service-layer actions in a dedicated refactor task.
