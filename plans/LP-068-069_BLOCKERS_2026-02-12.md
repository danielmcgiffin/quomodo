# LP-068 / LP-069 Blockers (2026-02-12)

This document captures what failed while executing `LP-068` and `LP-069`, current hypotheses, and checks that require founder/dashboard access.

## Scope

- Goal: close `LP-068` (first-customer onboarding validation) and `LP-069` (multi-user provisioning validation).
- Environment used: `SMOKE_BASE_URL=https://quomodo.danielmcgiffin.workers.dev` (and one cross-check against `https://systemscraft.co`).
- Date of evidence: 2026-02-12 (UTC).

## What Worked

- `LP-069` provisioning path executed successfully via `npm run -s provision:workspace`.
- Run evidence:
- `run_date_utc=2026-02-12T21:57:35.435Z`
- `org_id=851f91e4-7bc0-426c-bf70-b3c0b4687ce4`
- `PASS` admin membership assignment + verification
- `PASS` editor membership assignment + verification
- `PASS` member membership assignment + verification

## What Failed

- Deployed smoke (`npm run -s smoke:deployed`) failed at first app access check.
- Failure detail:
- owner authenticated successfully, then `/app/processes` returned HTTP `500` instead of `200`
- reproduced on both `https://quomodo.danielmcgiffin.workers.dev` and `https://systemscraft.co`
- Error page showed reference id:
- `ref: 054f92da-2cbd-4bf4-afdd-f9503b434450`

- Onboarding validation (`npm run -s onboarding:deployed`) failed before end-to-end completion.
- Run 1 failure:
- signup email format rejected by Supabase (`Email address "... is invalid"`)
- Run 2 failure:
- Supabase email rate limit (`email rate limit exceeded`)
- Run 3 (with fallback user creation):
- signup step `PASS` (admin fallback due rate limit)
- verify/sign-in step `PASS`
- profile creation step `FAIL` (`/account/api?/updateProfile` returned `500`)
- run timestamp: `2026-02-12T22:09:03.537Z`

## Quick Data Sanity Checks Already Done

- Owner sign-in with anon key succeeded.
- Owner membership lookup succeeded with owner role in org `851f91e4-7bc0-426c-bf70-b3c0b4687ce4`.
- Basic owner-scoped queries succeeded for `processes`, `roles`, `systems`, and `flags`.
- These checks suggest the data and RLS baseline are not completely broken.

## Ranked Hypotheses

1. Deployed worker runtime/config mismatch is causing server-side exceptions in page loads/actions even though direct client-auth DB reads work.
2. A production schema delta exists on non-triad tables used during onboarding, especially `profiles` writes in `/account/api?/updateProfile`.
3. One or more required env vars/secrets are inconsistent across environments (for example, Supabase URL/keys not all from the same project).
4. There is a route-level runtime bug in server load/action code paths not covered by local tests.

## Checks For Danny (Required)

- Cloudflare logs:
- Query logs for ref id `054f92da-2cbd-4bf4-afdd-f9503b434450`.
- Capture the exact `context` emitted by `throwRuntime500`/`logRuntimeError` for:
- `/app/processes`
- `/account/api?/updateProfile`

- Supabase schema checks (production project):
- Confirm `profiles` has expected columns used by current code:
- `id`, `updated_at`, `full_name`, `company_name`, `website`, `unsubscribed`
- Confirm trigger/function path for new users exists and is active:
- `public.handle_new_user`
- `on_auth_user_created` trigger on `auth.users`

- Secret/config alignment checks:
- Confirm all deployed env values point at the same Supabase project:
- `PUBLIC_SUPABASE_URL`
- `PUBLIC_SUPABASE_ANON_KEY`
- `PRIVATE_SUPABASE_SERVICE_ROLE`
- Confirm production and preview are in sync for required app secrets.

- Auth/rate-limit checks:
- If you want strict external-signup validation in LP-068, temporarily raise or bypass auth email rate limits for test runs.

## Checks For Codex After You Confirm

- Re-run:
- `npm run -s smoke:deployed`
- `npm run -s onboarding:deployed`
- Capture new timestamped PASS/FAIL results.
- If 500s persist, patch the failing route/action once Cloudflare runtime context pinpoints the exact failing function.

## Gemini Review: What Is Accurate vs Overstated

- Accurate:
- `src/routes/app/processes/[slug]/+page.server.ts` is a large mixed-responsibility route and is less clean than roles/systems routes.
- `resequenceProcessActions` is non-transactional and should eventually move to DB-side function/RPC for stronger safety.

- Partially accurate:
- Flag creation duplication exists, but process detail supports both `process` and `action` targets, which current shared helper does not model directly.
- So some inline logic is architectural debt, not necessarily a bug.

- Overstated:
- Current failures are runtime/deployment blockers (`500`s in critical flows), not proof that the whole architecture is broken.
- We have successful provisioning and successful direct DB auth/path checks in the same environment.

## Recommended Next Move

- Resolve the concrete runtime `500` root causes first (launch blockers).
- After launch blockers are closed, do the structural cleanup of `processes/[slug]` into service-layer actions in a dedicated refactor task.
