if command -v npm >/dev/null 2>&1; then
  # NixOS global node_modules live in the Nix store (read-only), so use a user prefix.
  export NPM_CONFIG_PREFIX="${HOME}/.npm-global"
  export PATH="${NPM_CONFIG_PREFIX}/bin:${PATH}"
  mkdir -p "${NPM_CONFIG_PREFIX}"

  latest_codex_version="$(npm view @openai/codex version 2>/dev/null)"
  if [ -n "$latest_codex_version" ]; then
    installed_codex_version="$(npm list -g --depth=0 --json @openai/codex 2>/dev/null | node -e 'let d=\"\";process.stdin.on(\"data\",c=>d+=c);process.stdin.on(\"end\",()=>{try{const j=JSON.parse(d);console.log(j.dependencies?.[\"@openai/codex\"]?.version||\"\");}catch(e){}});')"
    if [ -z "$installed_codex_version" ]; then
      echo "Codex CLI not found; installing latest ($latest_codex_version)..."
      npm install -g @openai/codex@"$latest_codex_version"
    elif [ "$installed_codex_version" != "$latest_codex_version" ]; then
      echo "Updating Codex CLI to $latest_codex_version..."
      npm install -g @openai/codex@"$latest_codex_version"
    fi
  else
    echo "Unable to fetch latest Codex version from npm."
  fi
else
  echo "npm not found; install Node.js/npm to use Codex."
fi
