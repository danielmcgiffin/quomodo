name: Tests

on: [push, pull_request]

env:
  # Prefer secrets; fall back to fake values so unit tests can still run in forks.
  PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL || 'https://fake_test_url.supabase.co' }}
  PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY || 'fake_anon_key' }}
  PRIVATE_SUPABASE_SERVICE_ROLE: ${{ secrets.PRIVATE_SUPABASE_SERVICE_ROLE || 'fake_service_role' }}
  PRIVATE_STRIPE_API_KEY: ${{ secrets.PRIVATE_STRIPE_API_KEY || 'fake_strip_api_key' }}

  # E2E auth (SR-05): set these in repo secrets to enable authenticated Playwright tests.
  E2E_EMAIL: ${{ secrets.E2E_EMAIL || '' }}
  E2E_PASSWORD: ${{ secrets.E2E_PASSWORD || '' }}

  # SR-05A (Dedicated E2E Supabase): override these in step-level env for Playwright.
  # Secrets expected:
  # - E2E_PUBLIC_SUPABASE_URL
  # - E2E_PUBLIC_SUPABASE_ANON_KEY
  # - E2E_PRIVATE_SUPABASE_SERVICE_ROLE
  # - E2E_PRIVATE_STRIPE_API_KEY (can be a test key for E2E project)

jobs:
  build_and_test:
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: NPM install
        run: npm install

      - name: Typecheck (svelte-check)
        run: npm run check

      - name: Tests
        run: npm run test_run

      - name: Install Playwright (Chromium)
        run: npx playwright install --with-deps chromium

      - name: Seed E2E fixtures
        run: npm run seed:e2e
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.E2E_PUBLIC_SUPABASE_URL || env.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.E2E_PUBLIC_SUPABASE_ANON_KEY || env.PUBLIC_SUPABASE_ANON_KEY }}
          PRIVATE_SUPABASE_SERVICE_ROLE: ${{ secrets.E2E_PRIVATE_SUPABASE_SERVICE_ROLE || env.PRIVATE_SUPABASE_SERVICE_ROLE }}
          PRIVATE_STRIPE_API_KEY: ${{ secrets.E2E_PRIVATE_STRIPE_API_KEY || env.PRIVATE_STRIPE_API_KEY }}

      - name: E2E (Playwright)
        run: npm run test:e2e
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.E2E_PUBLIC_SUPABASE_URL || env.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.E2E_PUBLIC_SUPABASE_ANON_KEY || env.PUBLIC_SUPABASE_ANON_KEY }}
          PRIVATE_SUPABASE_SERVICE_ROLE: ${{ secrets.E2E_PRIVATE_SUPABASE_SERVICE_ROLE || env.PRIVATE_SUPABASE_SERVICE_ROLE }}
          PRIVATE_STRIPE_API_KEY: ${{ secrets.E2E_PRIVATE_STRIPE_API_KEY || env.PRIVATE_STRIPE_API_KEY }}
